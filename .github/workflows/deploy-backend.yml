name: Deploy Backend   # ì›Œí¬í”Œë¡œìš° ì´ë¦„

on:
  push:
    branches: ["dev"]   # dev ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ì‹¤í–‰
  release:
    types: ["published"]  # Release ë°œí–‰ ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:       # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest   # GitHub Actions ì‹¤í–‰ í™˜ê²½ (Ubuntu)

    env:   # ì „ì²´ Jobì—ì„œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜
      IMAGE_NAME: gsc-portal-backend
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
      # ======================================================
      # 1) GitHub ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ======================================================
      - name: Checkout code
        uses: actions/checkout@v4



      # ======================================================
      # 2) Docker Buildx ì„¤ì •
      #    (ë©€í‹° í”Œë«í¼ ë¹Œë“œ ë° ê³ ê¸‰ ê¸°ëŠ¥ í™œì„±í™”)
      # ======================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # í•„ìˆ˜: BRANCH / SHORT_SHA ì„¤ì •
      - name: Extract Git metadata
        run: |
          echo "BRANCH=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "APP_VERSION=${GITHUB_REF##*/}-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # ======================================================
      # 3) DockerHub ë¡œê·¸ì¸ (í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”)
      # ======================================================
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


      # ======================================================
      # 4) Docker ì´ë¯¸ì§€ ë¹Œë“œ + DockerHub í‘¸ì‹œ
      #    - mac/ARM â†’ Linux/AMD64 ì„œë²„ í˜¸í™˜ ìœ„í•´ ë©€í‹°í”Œë«í¼ ë¹Œë“œ í•„ìš”
      #    - latest ë° sha ê¸°ë°˜ ë²„ì „ íƒœê·¸ ìƒì„±
      #    - registry ìºì‹œ ì‚¬ìš© (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      # ======================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            sgwar/gsc-portal-backend:latest
            sgwar/gsc-portal-backend:${{ env.BRANCH }}-${{ env.SHORT_SHA }}
          build-args: |
            APP_VERSION=${{ env.APP_VERSION }}
          cache-from: type=registry,ref=sgwar/gsc-portal-backend:buildcache
          cache-to: type=registry,ref=sgwar/gsc-portal-backend:buildcache,mode=max


      # ======================================================
      # 5) SSHë¡œ í•™êµ ì„œë²„ ì ‘ì† â†’ Docker ë°°í¬ ì‹¤í–‰
      #
      #   ê¸°ëŠ¥:
      #   âœ” ìƒˆ ì´ë¯¸ì§€ pull (ì†ë„/ë¶ˆì•ˆì •ì„± ëŒ€ë¹„)
      #   âœ” backend ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘ (no-deps)
      #   âœ” ë¶ˆí•„ìš” ì´ë¯¸ì§€ ìë™ ì •ë¦¬ (ë””ìŠ¤í¬ ë³´í˜¸)
      #   âœ” < /dev/null â†’ SSH ë¹„ëŒ€í™”ì‹ ì˜¤ë¥˜ ë°©ì§€
      # ======================================================
      - name: Deploy to School Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸš€ Deploying BACKEND to School Server..."

            cd ~/gsc-portal-infra   # ì„œë²„ì˜ í”„ë¡œì íŠ¸ ì¸í”„ë¼ í´ë”ë¡œ ì´ë™

            sudo docker compose -f docker-compose.prod.yml pull gsc_backend < /dev/null

            sudo docker compose -f docker-compose.prod.yml up -d --no-deps gsc_backend < /dev/null

            sudo docker image prune -f < /dev/null

            echo "âœ… Deployment to School Server complete!"


      # ======================================================
      # 6) Health Check (ë°°í¬ í›„ ì„œë¹„ìŠ¤ ì •ìƒë™ì‘ ê²€ì¦)
      #
      #   ê¸°ëŠ¥:
      #   âœ” /health ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œí•˜ì—¬ ì„œë²„ ìƒíƒœ í™•ì¸
      #   âœ” Redis / DB / CPU ë“± ë‚´ë¶€ í—¬ìŠ¤ì²´í¬ ëª¨ë‘ ë°˜ì˜
      #   âœ” curl -f â†’ HTTP 200ì´ ì•„ë‹ˆë©´ ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
      # ======================================================
      - name: Health check after deploy (dev)
        run: |
          echo "Health check on ${{ secrets.HEALTHCHECK_URL }}"
          curl -f ${{ secrets.HEALTHCHECK_URL }}